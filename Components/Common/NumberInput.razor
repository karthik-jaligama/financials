@using Microsoft.AspNetCore.Components
@inject IJSRuntime JSRuntime

<input type="text" 
       class="number-input" 
       @ref="inputRef"
       value="@FormattedValue" 
       @oninput="HandleNumberInput" 
       @onchange="HandleChange"
       @onblur="HandleBlur"
       @attributes="AdditionalAttributes" />

@code {
    [Parameter] public decimal? Value { get; set; }
    [Parameter] public EventCallback<decimal?> ValueChanged { get; set; }
    [Parameter] public EventCallback<decimal?> OnValueChanged { get; set; }
    [Parameter] public EventCallback<ChangeEventArgs> OnChange { get; set; }
    [Parameter] public string CssClass { get; set; } = "";
    [Parameter] public Dictionary<string, object> AdditionalAttributes { get; set; } = new();

    private ElementReference inputRef;
    private string FormattedValue => FormatNumber(Value ?? 0);

    private string FormatNumber(decimal value)
    {
        // If the decimal part is zero, format without decimals
        if (value % 1 == 0)
        {
            return value.ToString("N0");
        }
        return value.ToString("N2");
    }

    private async Task HandleNumberInput(ChangeEventArgs e)
    {
        Console.WriteLine($"[NumberInput] HandleNumberInput called - Raw Input: '{e.Value}'");
        
        if (e.Value == null) 
        {
            Console.WriteLine($"[NumberInput] HandleNumberInput - Input is null, returning");
            return;
        }
        
        string input = e.Value.ToString() ?? "";
        Console.WriteLine($"[NumberInput] HandleNumberInput - Processing input: '{input}'");
        
        // Special handling for decimal input
        if (input.EndsWith("."))
        {
            Console.WriteLine($"[NumberInput] HandleNumberInput - Input ends with decimal point, formatting and returning");
            await JSRuntime.InvokeVoidAsync("formatNumberInput", input);
            return;
        }

        // If we're in the middle of typing a decimal number, don't format yet
        if (input.Contains(".") && !input.EndsWith("."))
        {
            string[] parts = input.Split('.');
            if (parts.Length == 2 && parts[1].Length < 2)
            {
                Console.WriteLine($"[NumberInput] HandleNumberInput - Incomplete decimal input, formatting and returning");
                await JSRuntime.InvokeVoidAsync("formatNumberInput", input);
                return;
            }
        }
        
        // Remove any non-numeric characters except decimal point
        string numericOnly = new string(input.Where(c => char.IsDigit(c) || c == '.').ToArray());
        Console.WriteLine($"[NumberInput] HandleNumberInput - Numeric only: '{numericOnly}'");
        
        if (decimal.TryParse(numericOnly, out decimal result))
        {
            Console.WriteLine($"[NumberInput] HandleNumberInput - Parsed decimal: {result}");
            
            // Format the number with commas and 2 decimal places only if needed
            string formatted = FormatNumber(result);
            Console.WriteLine($"[NumberInput] HandleNumberInput - Formatted: '{formatted}'");
            
            // Update the input value using JS interop
            await JSRuntime.InvokeVoidAsync("formatNumberInput", formatted);
            
            // Update the bound value
            Console.WriteLine($"[NumberInput] HandleNumberInput - Invoking ValueChanged with: {result}");
            await ValueChanged.InvokeAsync(result);
            
            // Trigger additional callback if provided
            if (OnValueChanged.HasDelegate)
            {
                Console.WriteLine($"[NumberInput] HandleNumberInput - Invoking OnValueChanged with: {result}");
                await OnValueChanged.InvokeAsync(result);
            }
        }
        else
        {
            Console.WriteLine($"[NumberInput] HandleNumberInput - Failed to parse decimal from: '{numericOnly}'");
        }
    }

    private async Task HandleBlur(FocusEventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("handleInputBlur");
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        Console.WriteLine($"[NumberInput] HandleChange called - Raw Input: '{e.Value}'");
        Console.WriteLine($"[NumberInput] HandleChange - FormattedValue: '{FormattedValue}'");
        Console.WriteLine($"[NumberInput] HandleChange - Value property: '{Value}'");
        
        // Trigger the OnChange callback if provided
        if (OnChange.HasDelegate)
        {
            Console.WriteLine($"[NumberInput] HandleChange - Invoking OnChange callback with e.Value: '{e.Value}'");
            await OnChange.InvokeAsync(e);
        }
        else
        {
            Console.WriteLine($"[NumberInput] HandleChange - OnChange callback not provided");
        }
    }
}

<script>
    window.formatNumberInput = (value) => {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.classList.contains('number-input')) {
            activeElement.value = value;
        }
    };

    window.handleInputBlur = () => {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.classList.contains('number-input')) {
            // Set cursor to start of input
            activeElement.setSelectionRange(0, 0);
            
            // If the value ends with a decimal point, remove it
            if (activeElement.value.endsWith('.')) {
                activeElement.value = activeElement.value.slice(0, -1);
            }
        }
    };
</script>

<style>
    .number-input {
        color: #333;
        font-family: Inter, sans-serif;
        font-size: 16px;
        font-weight: 500;
        background: transparent;
        border: none;
        outline: none;
        padding: 0;
        margin: 0;
        box-shadow: none;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        text-align: right;
    }

    .number-input:focus {
        color: #333;
        background: transparent;
        outline: none;
    }

    .number-input:focus,
    .number-input:active,
    .number-input:hover {
        outline: none;
        background: transparent;
    }

    /* Special styling for tax-paid variant */
    .number-input.tax-paid {
        text-align: center;
    }
</style>
